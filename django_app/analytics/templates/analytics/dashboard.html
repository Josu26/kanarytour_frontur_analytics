<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>KanaryOS ¬∑ FRONTUR Canarias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Evita que iOS convierta n√∫meros en tel√©fonos -->
    <meta name="format-detection" content="telephone=no">
    {% load humanize static %}
    <style>
        :root {
            --bg: #f5f5f7;
            --bg-darker: #e5e7eb;
            --bg-card: #ffffff;
            --border-subtle: rgba(15,23,42,0.08);
            --accent: #facc15;
            --accent-soft: rgba(250,204,21,0.10);
            --accent-strong: #eab308;
            --text-main: #111827;
            --text-soft: #6b7280;
            --danger: #b91c1c;
            --success: #16a34a;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text-main);
        }

        a { color: inherit; }

        /* ==========
           LAYOUT
        ========== */

        .page-wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 24px 40px;
        }

        @media (max-width: 768px) {
            .page-wrap {
                padding: 16px 16px 32px;
            }
        }

        /* ==========
           HEADER / HERO
        ========== */

        header {
            background: #020617;
            border-bottom: 1px solid rgba(15,23,42,0.8);
            box-shadow: 0 18px 40px rgba(15,23,42,0.6);
            color: #f9fafb;
        }

        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 24px 18px;
            display: flex;
            justify-content: space-between;
            gap: 18px;
            align-items: center;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
            letter-spacing: 0.12em;
            font-weight: 600;
        }

        .header-subtitle {
            font-size: 0.9rem;
            color: #9ca3af;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .header-tag {
            font-size: 0.78rem;
            border-radius: 999px;
            padding: 5px 12px;
            border: 1px solid rgba(148,163,184,0.4);
            background: rgba(15,23,42,0.85);
            color: #e5e7eb;
        }

        .header-author {
            position: relative;          /* para que el tooltip se posicione respecto a este chip */
            font-size: 0.78rem;
            border-radius: 999px;
            padding: 5px 12px;
            border: 1px solid rgba(148,163,184,0.5);
            background: rgba(15,23,42,0.95);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: default;
        }

        .header-author span {
            color: #9ca3af;
        }

        .header-author a {
            color: var(--accent);
            font-weight: 500;
            text-decoration: none;
        }

        .header-author a:hover {
            text-decoration: underline;
        }

        .header-badge {
            border-radius: 999px;
            border: 1px solid rgba(22,163,74,0.4);
            padding: 5px 12px;
            font-size: 0.78rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(22,163,74,0.12);
            color: #bbf7d0;
        }

        .header-badge-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: #22c55e;
        }

        @media (max-width: 900px) {
            .header-inner {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-right {
                justify-content: flex-start;
            }
        }

        main { margin-top: 20px; }

        /* ==========
           TOOLTIP AUTOR
        ========== */

        .author-tooltip {
            position: absolute;
            top: 130%;
            right: 0;
            width: 260px;
            max-width: 80vw;
            background: #ffffff;
            border-radius: 14px;
            padding: 8px;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 18px 45px rgba(15,23,42,0.35);
            opacity: 0;
            transform: translateY(4px);
            pointer-events: none;
            transition: opacity 0.18s ease-out, transform 0.18s ease-out;
            z-index: 50;
        }

        .author-tooltip img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 10px;
        }

        .header-author:hover .author-tooltip {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        @media (max-width: 768px) {
            /* en m√≥vil lo desactivamos para no molestar */
            .author-tooltip {
                display: none;
            }
        }

        /* Intro hero card */

        .intro-card {
            margin-bottom: 22px;
            padding: 20px 22px;
            border-radius: 22px;
            border: 1px solid rgba(234,179,8,0.25);
            background: linear-gradient(135deg, #fefce8, #ffffff);
            display: flex;
            justify-content: space-between;
            gap: 18px;
            align-items: center;
            box-shadow: 0 18px 40px rgba(15,23,42,0.06);
        }

        .intro-text {
            font-size: 0.95rem;
            color: var(--text-soft);
            max-width: 70%;
            line-height: 1.55;
        }

        .intro-text strong {
            color: var(--text-main);
            font-size: 1.02rem;
        }

        .intro-meta {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .analyst-tag {
            font-size: 0.76rem;
            border-radius: 999px;
            padding: 4px 10px;
            border: 1px solid var(--border-subtle);
            color: var(--text-soft);
            background: #f9fafb;
        }

        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 7px 16px;
            border-radius: 999px;
            border: 1px solid rgba(234,179,8,0.8);
            background: #fefce8;
            color: #854d0e;
            font-size: 0.8rem;
            text-decoration: none;
            font-weight: 500;
        }

        .download-btn span:first-child { font-size: 0.9rem; }

        @media (max-width: 900px) {
            .intro-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .intro-text { max-width: 100%; }

            .intro-meta { align-items: flex-start; }
        }

        /* ==========
           FILTROS
        ========== */

        .filters-bar {
            margin-bottom: 24px;
            padding: 14px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-subtle);
            background: #ffffff;
            display: flex;
            flex-wrap: wrap;
            gap: 14px 20px;
            align-items: flex-end;
        }

        .filters-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 16px;
            align-items: flex-end;
        }

        .filters-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 130px;
        }

        .filters-label {
            font-size: 0.76rem;
            color: var(--text-soft);
        }

        .filters-select,
        .filters-input {
            background: #f9fafb;
            color: var(--text-main);
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            padding: 6px 10px;
            font-size: 0.8rem;
            min-height: 30px;
        }

        .filters-input { width: 100px; }

        .filters-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .filters-submit,
        .filters-reset {
            border-radius: 999px;
            padding: 7px 14px;
            font-size: 0.8rem;
            border: 1px solid var(--border-subtle);
            background: #ffffff;
            color: var(--text-main);
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        .filters-submit {
            border-color: rgba(234,179,8,0.9);
            background: #fef9c3;
            color: #854d0e;
            font-weight: 500;
        }

        .filters-reset { color: var(--text-soft); }

        @media (max-width: 900px) {
            .filters-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            .filters-actions { margin-left: 0; }
        }

        /* ==========
           CARDS / GRID
        ========== */

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 18px;
            margin-bottom: 26px;
        }

        .kpi-grid-secondary {
            margin-top: -6px;
            margin-bottom: 26px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 16px 18px;
            box-shadow: 0 18px 45px rgba(15,23,42,0.04);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            max-width: 100%;
            width: 100%;
        }

        .card h2 {
            font-size: 0.82rem;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            margin: 0 0 6px 0;
            color: var(--text-soft);
        }

        .card-value {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .card-sub {
            font-size: 0.86rem;
            color: var(--text-soft);
            margin-top: 6px;
            line-height: 1.45;
        }

        .card-value-small { font-size: 1.35rem; }

        .kpi-change {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.84rem;
            margin-top: 6px;
        }

        .kpi-change.positive { color: var(--success); }
        .kpi-change.negative { color: var(--danger); }

        .kpi-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
        }

        .kpi-dot.positive { background: var(--success); }
        .kpi-dot.negative { background: var(--danger); }

        .tag-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.76rem;
            background: var(--accent-soft);
            color: var(--accent-strong);
            margin-top: 8px;
        }

        .tag-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: var(--accent-strong);
        }

        .layout-2col {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
            gap: 18px;
            margin-bottom: 26px;
        }

        .chart-card { position: relative; }

        .islands-card {
            height: auto;
            min-height: 320px;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 230px;
            margin-top: 10px;
            overflow: hidden;
        }

        .chart-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        @media (max-width: 900px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .layout-2col { grid-template-columns: 1fr; }
        }

        /* ==========
           TOP 5 / TABLAS
        ========== */

        .top5-list {
            margin: 8px 0 0 0;
            padding: 0;
            list-style: none;
        }

        .top5-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.84rem;
            padding: 4px 0;
            border-bottom: 1px solid rgba(148,163,184,0.18);
        }

        .top5-item span:first-child {
            max-width: 70%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .top5-item span:last-child {
            font-variant-numeric: tabular-nums;
        }

        .table-card { margin-top: 14px; }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
        }

        .table-header-title {
            font-size: 0.95rem;
            font-weight: 500;
        }

        .table-header-sub {
            font-size: 0.84rem;
            color: var(--text-soft);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            background: #ffffff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        thead { background: #f9fafb; }

        th, td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(148,163,184,0.25);
            text-align: left;
            white-space: nowrap;
        }

        th {
            font-weight: 600;
            color: var(--text-soft);
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        tbody tr:nth-child(odd) { background: #ffffff; }
        tbody tr:nth-child(even) { background: #f9fafb; }

        tbody tr:hover {
            background: #eef2ff;
        }

        .footer {
            margin-top: 14px;
            font-size: 0.76rem;
            color: var(--text-soft);
            text-align: right;
        }

        details.table-details { margin-top: 6px; }

        details.table-details summary {
            cursor: pointer;
            font-size: 0.84rem;
            color: var(--text-soft);
            list-style: none;
        }

        details.table-details summary::marker { content: ""; }

        details.table-details summary::before {
            content: "‚ñ∂";
            margin-right: 6px;
            font-size: 0.7rem;
        }

        details.table-details[open] summary::before { content: "‚ñº"; }

        .mini-table-wrapper {
            margin-top: 10px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
            background: #ffffff;
        }

        .mini-table {
            width: 100%;
            border-collapse: collapse;
        }

        .mini-table th,
        .mini-table td {
            padding: 6px 8px;
            border-bottom: 1px solid rgba(148,163,184,0.25);
            text-align: left;
            font-size: 0.8rem;
        }

        .mini-table th { color: var(--text-soft); }

        /* ==========
           BLOQUE ISLAS + MAPA
        ========== */

        .islands-combo {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1.6fr);
            gap: 18px;
            align-items: stretch;
            margin-top: 12px;
        }

        .islands-map-wrapper {
            position: relative;
            border-radius: 18px;
            padding: 8px;
            border: 1px solid var(--border-subtle);
            background: #f9fafb;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .islands-map-title {
            font-size: 0.82rem;
            color: var(--text-soft);
            margin-left: 4px;
        }

        .map-container {
            border-radius: 14px;
            overflow: hidden;
            position: relative;
            width: 100%;
            padding-bottom: 60%;
        }

        .leaflet-container {
            width: 100%;
            height: 100%;
            background: #f3f4f6;
            font-family: inherit;
        }

        #canaryMap {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
        }

        .leaflet-control-attribution {
            font-size: 9px;
            color: #6b7280;
        }

        .leaflet-control-attribution a {
            color: #4b5563;
        }

        .leaflet-control-zoom a {
            background: #ffffff;
            color: #111827;
            border: 1px solid var(--border-subtle);
        }

        .leaflet-control-zoom a:hover { background: #e5e7eb; }

        @media (max-width: 900px) {
            .islands-combo { grid-template-columns: 1fr; }
            .map-container { padding-bottom: 70%; }
        }

        /* ==========
           CONTROLES DE GR√ÅFICO
        ========== */

        .chart-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            font-size: 0.84rem;
            margin-bottom: 4px;
            color: var(--text-soft);
        }

        .chart-controls select {
            background: #f9fafb;
            color: var(--text-main);
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            padding: 4px 10px;
            font-size: 0.8rem;
        }

        /* ==========
           FEEDBACK BUTTON + MODAL
        ========== */

        .feedback-trigger {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 9999;
            border-radius: 999px;
            border: 1px solid rgba(234,179,8,0.8);
            background: #fef9c3;
            color: #854d0e;
            padding: 10px 16px;
            font-size: 0.82rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 12px 28px rgba(15,23,42,0.18);
        }

        .feedback-trigger span:first-child { font-size: 1rem; }

        .feedback-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.55);
            backdrop-filter: blur(6px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2100;
        }

        .feedback-modal-overlay.visible { display: flex; }

        .feedback-modal {
            width: 100%;
            max-width: 420px;
            background: #ffffff;
            border-radius: 22px;
            padding: 18px 20px 16px;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 24px 60px rgba(15,23,42,0.30);
            position: relative;
            z-index: 2200;
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 10px;
        }

        .feedback-title {
            font-size: 0.96rem;
            font-weight: 600;
        }

        .feedback-sub {
            font-size: 0.84rem;
            color: var(--text-soft);
        }

        .feedback-close-btn {
            border: none;
            background: transparent;
            color: var(--text-soft);
            cursor: pointer;
            font-size: 1rem;
        }

        .feedback-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 4px;
        }

        .feedback-field-label {
            font-size: 0.82rem;
            color: var(--text-soft);
            margin-bottom: 3px;
        }

        .feedback-rating-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .feedback-chip {
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            padding: 4px 9px;
            font-size: 0.78rem;
            background: #f9fafb;
            color: var(--text-soft);
            cursor: pointer;
        }

        .feedback-chip input { display: none; }

        .feedback-chip.selected {
            border-color: rgba(234,179,8,0.95);
            background: #fef9c3;
            color: #854d0e;
        }

        .feedback-select {
            width: 100%;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: #f9fafb;
            color: var(--text-main);
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .feedback-textarea {
            width: 100%;
            min-height: 70px;
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            background: #f9fafb;
            color: var(--text-main);
            padding: 8px 10px;
            font-size: 0.8rem;
            resize: vertical;
        }

        .feedback-inline-note {
            font-size: 0.76rem;
            color: var(--text-soft);
        }

        .feedback-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
            gap: 10px;
        }

        .feedback-submit-btn {
            border-radius: 999px;
            border: 1px solid rgba(234,179,8,0.9);
            padding: 7px 14px;
            font-size: 0.82rem;
            background: #fef9c3;
            color: #854d0e;
            cursor: pointer;
            font-weight: 500;
        }

        .feedback-secondary-btn {
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            padding: 6px 12px;
            font-size: 0.8rem;
            background: #ffffff;
            color: var(--text-soft);
            cursor: pointer;
        }

        .feedback-status {
            font-size: 0.78rem;
            color: var(--text-soft);
            margin-top: 6px;
            min-height: 16px;
        }

        .feedback-status.success { color: var(--success); }
        .feedback-status.error { color: var(--danger); }

        /* ==========
           RESPONSIVE MOBILE EXTRA
        ========== */

        @media (max-width: 768px) {

            .card,
            .intro-card,
            .filters-bar,
            .table-card {
                padding: 14px 14px;
                border-radius: 18px;
            }

            .card-value,
            .card-value-small {
                font-size: 1.3rem;
                word-break: break-word;
            }

            .filters-actions {
                width: 100%;
                flex-direction: column;
                align-items: stretch;
            }

            .filters-submit,
            .filters-reset,
            .feedback-submit-btn,
            .feedback-secondary-btn {
                width: 100%;
                margin-top: 4px;
            }

            select,
            input,
            .filters-select,
            .filters-input,
            .feedback-select {
                width: 100%;
            }

            table { font-size: 0.82rem; }

            .feedback-trigger {
                bottom: 14px;
                right: 14px;
            }
        }
    </style>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet (mapa real) -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin=""
    />
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        crossorigin="">
    </script>
</head>

<body>

<header>
    <div class="header-inner">
        <div class="header-left">
            <h1>KanaryOS ¬∑ FRONTUR CANARIAS</h1>
            <div class="header-subtitle">
                Turismo internacional en Canarias ¬∑ FRONTUR (ISTAC) ¬∑ Pipeline ETL ‚Üí SQLite ‚Üí Django.
            </div>
        </div>
        <div class="header-right">
            <span class="header-tag">Portfolio ¬∑ Data &amp; BI</span>

            <!-- chip autor con tooltip -->
            <div class="header-author">
                <span>Creado por</span>
                <a href="https://www.linkedin.com/in/josueperezcastillo" target="_blank" rel="noopener">
                    Josu√© D. P√©rez
                </a>

                <!-- TOOLTIP: sustituye la ruta por la tuya -->
                <div class="author-tooltip">
                    <img src="{% static 'img/linkedin_banner_josue.png' %}"
                         alt="Perfil de LinkedIn de Josu√© D. P√©rez Castillo">
                </div>
            </div>

            <div class="header-badge">
                <span class="header-badge-dot"></span>
                <span>Pipeline activo</span>
            </div>
        </div>
    </div>
</header>

<div class="page-wrap">
<main>

    <!-- Intro + bot√≥n descarga + modo analista -->
    <section class="intro-card">
        <div class="intro-text">
            <strong>Panel ejecutivo de turismo internacional en Canarias (FRONTUR ‚Äì ISTAC).</strong><br>
            Incluye evoluci√≥n temporal, impacto COVID, cuota entre islas, mercados principales y patr√≥n estacional
            a partir del dataset de observaciones FRONTUR para Canarias.
        </div>
        <div class="intro-meta">
            <span class="analyst-tag">Modo analista ¬∑ filtros avanzados</span>
            <a href="{% url 'download_clean_csv' %}{% if query_string %}?{{ query_string }}{% endif %}" class="download-btn">
                <span>‚¨á</span>
                <span>Descargar dataset limpio (CSV)</span>
            </a>
        </div>
    </section>

    <!-- Filtros avanzados -->
    <form method="get" class="filters-bar">
        <div class="filters-group">
            <div class="filters-field">
                <span class="filters-label">Residencia</span>
                <select name="residence" class="filters-select">
                    <option value="">Todas</option>
                    {% for res in available_residences %}
                        <option value="{{ res }}" {% if current_residence == res %}selected{% endif %}>
                            {{ res }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filters-field">
                <span class="filters-label">Isla (bloque islas)</span>
                <select name="island" class="filters-select">
                    <option value="">Todas</option>
                    {% for isl in available_islands %}
                        <option value="{{ isl }}" {% if current_island == isl %}selected{% endif %}>
                            {{ isl }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filters-field">
                <span class="filters-label">A√±o desde</span>
                <select name="year_from" class="filters-select">
                    <option value="">Min</option>
                    {% for y in years_available %}
                        <option value="{{ y }}" {% if current_year_from == y %}selected{% endif %}>
                            {{ y }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filters-field">
                <span class="filters-label">A√±o hasta</span>
                <select name="year_to" class="filters-select">
                    <option value="">Max</option>
                    {% for y in years_available %}
                        <option value="{{ y }}" {% if current_year_to == y %}selected{% endif %}>
                            {{ y }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="filters-group">
            <div class="filters-field">
                <span class="filters-label">Comparar a√±o A</span>
                <select name="year_a" class="filters-select">
                    <option value="">‚Äî</option>
                    {% for y in years_available %}
                        <option value="{{ y }}" {% if year_compare_a == y %}selected{% endif %}>
                            {{ y }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filters-field">
                <span class="filters-label">Con a√±o B</span>
                <select name="year_b" class="filters-select">
                    <option value="">‚Äî</option>
                    {% for y in years_available %}
                        <option value="{{ y }}" {% if year_compare_b == y %}selected{% endif %}>
                            {{ y }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            {% if year_compare_a and year_compare_b and year_compare_delta is not none %}
                <div class="filters-field">
                    <span class="filters-label">Resultado comparaci√≥n</span>
                    <div style="font-size:0.82rem;">
                        {% if year_compare_delta >= 0 %}
                            <span style="color: var(--success);">
                                +{{ year_compare_delta|floatformat:"1" }} % turistas
                            </span>
                        {% else %}
                            <span style="color: var(--danger);">
                                {{ year_compare_delta|floatformat:"1" }} % turistas
                            </span>
                        {% endif %}
                        entre <strong>{{ year_compare_a }}</strong> y <strong>{{ year_compare_b }}</strong>.
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="filters-actions">
            <button type="submit" class="filters-submit">Aplicar filtros</button>
            <a href="{% url 'dashboard' %}" class="filters-reset">Reset</a>
        </div>
    </form>

    <!-- KPIs principales -->
    <section class="kpi-grid">
        <article class="card">
            <h2>Registros cargados</h2>
            <div class="card-value">
                {{ total_rows|default:"0"|intcomma }}
            </div>
            <div class="card-sub">
                Filas actualmente le√≠das de <code>{{ TABLE_NAME }}</code>.
            </div>
        </article>

        <article class="card">
            <h2>Rango temporal</h2>
            {% if date_min and date_max %}
                <div class="card-value">{{ date_min }} ‚Üí {{ date_max }}</div>
                <div class="card-sub">Basado en combinaci√≥n <strong>year</strong> + <strong>month</strong>.</div>
            {% else %}
                <div class="card-value">N/D</div>
                <div class="card-sub">No se ha podido calcular el rango temporal.</div>
            {% endif %}
        </article>

        <article class="card">
            <h2>Turistas totales (muestra)</h2>
            {% if total_visitors is not none %}
                <div class="card-value">{{ total_visitors|floatformat:"0"|intcomma }}</div>
                <div class="card-sub">Suma de la columna <strong>tourists</strong> en el subconjunto cargado.</div>
                <div class="tag-pill">
                    <span class="tag-dot"></span>
                    <span>Fuente: ISTAC ¬∑ FRONTUR</span>
                </div>
            {% else %}
                <div class="card-value">N/D</div>
                <div class="card-sub">No se ha podido sumar la columna de turistas.</div>
            {% endif %}
        </article>
    </section>

    <!-- KPIs avanzados -->
    <section class="kpi-grid kpi-grid-secondary">
        <article class="card">
            <h2>Turistas √∫ltimos 12 meses</h2>
            {% if kpi_last_12m is not none %}
                <div class="card-value card-value-small">
                    {{ kpi_last_12m|floatformat:"0"|intcomma }}
                </div>
                <div class="card-sub">
                    Suma de los √∫ltimos 12 meses disponibles (todas las residencias).
                </div>
            {% else %}
                <div class="card-value card-value-small">N/D</div>
                <div class="card-sub">
                    No hay 12 meses disponibles en el subconjunto de datos.
                </div>
            {% endif %}
        </article>

        <article class="card">
            <h2>vs 12 meses anteriores</h2>
            {% if kpi_last_12m is not none and kpi_prev_12m is not none and kpi_last_12m_growth_pct is not none %}
                <div class="card-value card-value-small">
                    {{ kpi_prev_12m|floatformat:"0"|intcomma }}
                </div>
                <div class="kpi-change {% if kpi_last_12m_growth_pct >= 0 %}positive{% else %}negative{% endif %}">
                    <span class="kpi-dot {% if kpi_last_12m_growth_pct >= 0 %}positive{% else %}negative{% endif %}"></span>
                    <span>
                        {% if kpi_last_12m_growth_pct >= 0 %}+{% endif %}
                        {{ kpi_last_12m_growth_pct|floatformat:"1" }} %
                        vs periodo anterior
                    </span>
                </div>
                <div class="card-sub">
                    Comparaci√≥n de tr√°fico entre los √∫ltimos 12 meses y los 12 anteriores.
                </div>
            {% else %}
                <div class="card-value card-value-small">N/D</div>
                <div class="card-sub">
                    No hay suficientes datos para comparar dos periodos de 12 meses.
                </div>
            {% endif %}
        </article>

        <article class="card">
            <h2>Mes pico de turistas</h2>
            {% if best_period_label and best_period_value %}
                <div class="card-value card-value-small">
                    {{ best_period_value|floatformat:"0"|intcomma }}
                </div>
                <div class="card-sub">
                    M√°ximo mensual en <strong>{{ best_period_label }}</strong> (todas las residencias).
                </div>
            {% else %}
                <div class="card-value card-value-small">N/D</div>
                <div class="card-sub">
                    No se pudo identificar un mes pico con los datos actuales.
                </div>
            {% endif %}
        </article>
    </section>

    <!-- Gr√°fico principal + Top 5 pa√≠ses -->
    <section class="layout-2col">
        <article class="card chart-card">
            <div class="chart-controls">
                <label for="residenceFilter">Serie mostrada:</label>
                <select id="residenceFilter">
                    <option value="__all__">Todas las residencias (agregado)</option>
                    {% for item in top_residences %}
                        <option value="{{ item.residence }}">{{ item.residence }}</option>
                    {% endfor %}
                </select>
            </div>
            <h2>Evoluci√≥n mensual total de turistas</h2>
            <div class="card-sub">
                Serie agregada para todas las residencias o para el pa√≠s seleccionado. Estacionalidad y shocks (COVID, etc.).
            </div>
            <div class="chart-wrapper">
                <canvas id="touristsChart"></canvas>
            </div>
        </article>

        <article class="card">
            <h2>Top 5 pa√≠ses de residencia</h2>
            <div class="card-sub">
                Seg√∫n turistas acumulados en el subconjunto de datos cargado.
            </div>
            <ul class="top5-list">
                {% if top_residences %}
                    {% for item in top_residences %}
                        <li class="top5-item">
                            <span title="{{ item.residence }}">{{ item.residence }}</span>
                            <span>{{ item.tourists|floatformat:"0"|intcomma }}</span>
                        </li>
                    {% endfor %}
                {% else %}
                    <li class="top5-item">
                        <span>No hay datos suficientes.</span>
                        <span>‚Äî</span>
                    </li>
                {% endif %}
            </ul>

            {% if main_market_name and main_market_share and top3_share %}
                <div class="card-sub" style="margin-top: 10px;">
                    Mercado principal: <strong>{{ main_market_name }}</strong>
                    ({{ main_market_share|floatformat:"1" }} % del total).<br>
                    Los 3 primeros mercados concentran
                    <strong>{{ top3_share|floatformat:"1" }} %</strong> de los turistas.
                </div>
            {% endif %}
        </article>
    </section>

    <!-- COMPARATIVA ENTRE ISLAS + MAPA REAL + REPARTO -->
    <section class="layout-2col">
        <!-- Izquierda: comparativa + mapa -->
        <article class="card chart-card islands-card">
            <h2>Comparativa entre islas</h2>
            <div class="card-sub">
                Cuota de turistas por isla en los √∫ltimos 12 meses disponibles (todas las residencias).
            </div>

            <div class="islands-combo">
                <!-- Bar chart -->
                <div class="chart-wrapper">
                    <canvas id="islandsChart"></canvas>
                </div>

                <!-- Mapa real con Leaflet -->
                <div class="islands-map-wrapper">
                    <div class="islands-map-title">
                        Mapa real de Canarias ¬∑ Cuota por isla (√∫ltimos 12 meses).
                    </div>
                    <div class="map-container">
                        <div id="canaryMap"></div>
                    </div>
                </div>
            </div>
        </article>

        <!-- Derecha: reparto de turistas por islas -->
        <article class="card">
            <h2>Reparto de turistas por islas</h2>
            {% if islands_total_12m is not none %}
                <div class="card-sub">
                    ‚Ä¢ Turistas √∫ltimos 12 meses (todas las islas):
                    <strong>{{ islands_total_12m|intcomma }}</strong>.<br>
                    {% if island_leader_name and island_leader_share %}
                        ‚Ä¢ Isla l√≠der:
                        <strong>{{ island_leader_name }}</strong>
                        ({{ island_leader_share|floatformat:"1" }} % del total anual).<br>
                    {% endif %}
                    {% if islands_top3_share %}
                        ‚Ä¢ Las 3 islas con mayor tr√°fico concentran
                        <strong>{{ islands_top3_share|floatformat:"1" }} %</strong> de los turistas.
                    {% endif %}
                </div>

                <div class="mini-table-wrapper">
                    <table class="mini-table">
                        <thead>
                            <tr>
                                <th>Isla</th>
                                <th>Turistas 12M</th>
                                <th>Cuota</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in islands_table %}
                                <tr>
                                    <td>{{ item.island }}</td>
                                    <td>{{ item.tourists_12m|intcomma }}</td>
                                    <td>{{ item.share_pct|floatformat:"1" }} %</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="card-sub">
                    No hay informaci√≥n de islas suficiente para el √∫ltimo a√±o en la tabla de islas.
                </div>
            {% endif %}
        </article>
    </section>

    <!-- Estacionalidad + impacto COVID -->
    <section class="layout-2col">
        <article class="card chart-card">
            <h2>Patr√≥n estacional t√≠pico</h2>
            <div class="card-sub">
                Media de turistas por mes a lo largo de todos los a√±os disponibles.
            </div>
            <div class="chart-wrapper">
                <canvas id="seasonalityChart"></canvas>
            </div>
        </article>

        <article class="card">
            <h2>Impacto COVID y recuperaci√≥n</h2>
            {% if baseline_avg is not none and covid_min_label and covid_min_val is not none and covid_drop_pct is not none %}
                <div class="card-sub">
                    ‚Ä¢ Media mensual pre-COVID (‚â§ 2019):
                    <strong>{{ baseline_avg|floatformat:"0"|intcomma }}</strong> turistas.<br>
                    ‚Ä¢ M√≠nimo en <strong>{{ covid_min_label }}</strong>:
                    <strong>{{ covid_min_val|floatformat:"0"|intcomma }}</strong>
                    ({{ covid_drop_pct|floatformat:"1" }} % vs media previa).<br>
                    {% if recovery_month_label %}
                        ‚Ä¢ Recuperaci√≥n (‚â• 90 % de la media pre-COVID) a partir de
                        <strong>{{ recovery_month_label }}</strong>.
                    {% else %}
                        ‚Ä¢ A√∫n no se ha alcanzado el 90 % de la media pre-COVID en el periodo cargado.
                    {% endif %}
                </div>
            {% else %}
                <div class="card-sub">
                    No hay suficiente hist√≥rico para calcular el impacto de la COVID con esta muestra.
                </div>
            {% endif %}
        </article>
    </section>

    <!-- Tabla detallada colapsada -->
    <section class="card table-card">
        <details class="table-details">
            <summary>Ver tabla detallada (modo analista)</summary>

            <div class="table-header">
                <div class="table-header-title">
                    √öltimos registros FRONTUR Canarias (hasta 500 filas)
                </div>
                <div class="table-header-sub">
                    {% if columns %}
                        {{ columns|length }} columnas ¬∑ {{ total_rows|intcomma }} filas
                    {% else %}
                        Sin datos cargados
                    {% endif %}
                </div>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            {% for col in columns %}
                                <th>{{ col }}</th>
                            {% endfor %}
                        </tr>
                    </thead>

                    <tbody>
                        {% if rows %}
                            {% for row in rows %}
                                <tr>
                                    {% for cell in row %}
                                        <td>{{ cell }}</td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="{% if columns %}{{ columns|length }}{% else %}1{% endif %}">
                                    No hay registros para mostrar.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <div class="footer">
                Proyecto portfolio ¬∑ Datos: ISTAC (FRONTUR Canarias, observaciones) ¬∑ Renderizado desde SQLite con Django.
                <br>
                Autor: Josu√© D. P√©rez ¬∑
                <a href="https://www.linkedin.com/in/josueperezcastillo" target="_blank" rel="noopener"
                   style="color:#b45309;text-decoration:none;">
                    linkedin.com/in/josueperezcastillo
                </a>
            </div>
        </details>
    </section>

</main>
</div>

<!-- BOT√ìN FLOTANTE DE FEEDBACK -->
<button type="button" class="feedback-trigger" id="feedbackTrigger">
    <span>üí¨</span>
    <span>Feedback del dashboard</span>
</button>

<!-- MODAL FEEDBACK -->
<div class="feedback-modal-overlay" id="feedbackModalOverlay" aria-hidden="true">
    <div class="feedback-modal" role="dialog" aria-modal="true" aria-labelledby="feedbackTitle">
        <div class="feedback-header">
            <div>
                <div class="feedback-title" id="feedbackTitle">
                    ¬øQu√© te ha parecido este dashboard?
                </div>
                <div class="feedback-sub">
                    Tu opini√≥n me ayuda a mejorar el portfolio y los pr√≥ximos proyectos.
                </div>
            </div>
            <button type="button" class="feedback-close-btn" id="feedbackCloseBtn" aria-label="Cerrar">
                ‚úï
            </button>
        </div>

        <form class="feedback-form" id="feedbackForm">
            <div>
                <div class="feedback-field-label">
                    En general, ¬øc√≥mo valorar√≠as este dashboard?
                </div>
                <div class="feedback-rating-group" id="feedbackRatingGroup">
                    <label class="feedback-chip">
                        <input type="radio" name="rating" value="1">
                        1 ¬∑ Necesita mucho trabajo
                    </label>
                    <label class="feedback-chip">
                        <input type="radio" name="rating" value="2">
                        2 ¬∑ Mejorable
                    </label>
                    <label class="feedback-chip">
                        <input type="radio" name="rating" value="3">
                        3 ¬∑ Correcto
                    </label>
                    <label class="feedback-chip">
                        <input type="radio" name="rating" value="4">
                        4 ¬∑ Muy bien
                    </label>
                    <label class="feedback-chip">
                        <input type="radio" name="rating" value="5">
                        5 ¬∑ Excelente
                    </label>
                </div>
            </div>

            <div>
                <div class="feedback-field-label">
                    ¬øQu√© te ha parecido m√°s?
                </div>
                <select name="aspect" class="feedback-select">
                    <option value="">Selecciona una opci√≥n</option>
                    <option value="claridad">La claridad de la historia de datos</option>
                    <option value="diseno">El dise√±o y visualizaci√≥n</option>
                    <option value="interaccion">Los filtros e interacci√≥n</option>
                    <option value="insights">Los insights y KPIs elegidos</option>
                    <option value="otro">Otra cosa</option>
                </select>
            </div>

            <div>
                <div class="feedback-field-label">
                    Comentario (opcional)
                </div>
                <textarea
                    name="comment"
                    class="feedback-textarea"
                    placeholder="¬øQu√© mejorar√≠as o qu√© te ha gustado especialmente?"></textarea>
                <div class="feedback-inline-note">
                    Puedes dejarlo en blanco si vas con prisa.
                </div>
            </div>

            <div class="feedback-actions">
                <button type="button" class="feedback-secondary-btn" id="feedbackNotNowBtn">
                    Ahora no
                </button>
                <button type="submit" class="feedback-submit-btn">
                    Enviar feedback
                </button>
            </div>

            <div class="feedback-status" id="feedbackStatus"></div>
        </form>
    </div>
</div>

<script>
    // Serie total (todas las residencias)
    const chartLabelsAll = JSON.parse('{{ chart_labels|escapejs }}');
    const chartValuesAll = JSON.parse('{{ chart_values|escapejs }}');

    // Estacionalidad media por mes
    const seasonLabels = JSON.parse('{{ season_labels|escapejs }}');
    const seasonValues = JSON.parse('{{ season_values|escapejs }}');

    // Series por residencia
    const SERIES_BY_RESIDENCE = JSON.parse('{{ series_per_residence_json|escapejs }}');

    // Datos por islas
    const ISLAND_LABELS = JSON.parse('{{ island_labels_json|escapejs }}');
    const ISLAND_SHARES = JSON.parse('{{ island_shares_json|escapejs }}');
    const ISLANDS_MAP = JSON.parse('{{ islands_map_json|escapejs }}');

    // =========================
    //  GR√ÅFICO PRINCIPAL
    // =========================
    const ctx = document.getElementById('touristsChart');
    let touristsChart = null;

    if (ctx && chartLabelsAll.length > 0) {
        touristsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabelsAll,
                datasets: [{
                    label: 'Turistas totales (todas las residencias)',
                    data: chartValuesAll,
                    borderWidth: 2,
                    tension: 0.25,
                    pointRadius: 2.5,
                    pointHitRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    x: { ticks: { maxTicksLimit: 8 } },
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('es-ES');
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: { font: { size: 11 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const v = context.parsed.y || 0;
                                return ' ' + v.toLocaleString('es-ES') + ' turistas';
                            }
                        }
                    }
                }
            }
        });
    }

    // Selector de residencia
    const filterSelect = document.getElementById('residenceFilter');
    if (filterSelect && touristsChart) {
        filterSelect.addEventListener('change', function () {
            const value = this.value;
            let labels = chartLabelsAll;
            let values = chartValuesAll;
            let labelText = 'Turistas totales (todas las residencias)';

            if (value !== '__all__' && SERIES_BY_RESIDENCE[value]) {
                labels = SERIES_BY_RESIDENCE[value].labels;
                values = SERIES_BY_RESIDENCE[value].values;
                labelText = 'Turistas desde ' + value;
            }

            touristsChart.data.labels = labels;
            touristsChart.data.datasets[0].data = values;
            touristsChart.data.datasets[0].label = labelText;
            touristsChart.update();
        });
    }

    // =========================
    //  ESTACIONALIDAD
    // =========================
    const ctxSeason = document.getElementById('seasonalityChart');
    if (ctxSeason && seasonLabels.length > 0) {
        new Chart(ctxSeason, {
            type: 'bar',
            data: {
                labels: seasonLabels,
                datasets: [{
                    label: 'Media mensual de turistas',
                    data: seasonValues
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('es-ES');
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: { font: { size: 11 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const v = context.parsed.y || 0;
                                return ' ' + v.toLocaleString('es-ES') + ' turistas';
                            }
                        }
                    }
                }
            }
        });
    }

    // =============================
    //  COMPARATIVA ISLAS + MAPA REAL
    // =============================

    // 1) Gr√°fico de barras
    const ctxIslands = document.getElementById('islandsChart');
    let islandsChart = null;

    if (ctxIslands && ISLAND_LABELS.length > 0) {
        islandsChart = new Chart(ctxIslands, {
            type: 'bar',
            data: {
                labels: ISLAND_LABELS,
                datasets: [{
                    label: '% de turistas (√∫ltimos 12 meses)',
                    data: ISLAND_SHARES,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + ' %';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: { font: { size: 11 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                const v = ctx.parsed.y || 0;
                                return ' ' + v.toFixed(1) + ' % de los turistas';
                            }
                        }
                    }
                },
                onHover: (event, elements) => {
                    if (elements && elements.length > 0) {
                        const idx = elements[0].index;
                        const islandName = ISLAND_LABELS[idx];
                        highlightIslandOnMap(islandName, false);
                    } else {
                        highlightIslandOnMap(null, false);
                    }
                },
                onClick: (event, elements) => {
                    if (elements && elements.length > 0) {
                        const idx = elements[0].index;
                        const islandName = ISLAND_LABELS[idx];
                        highlightIslandOnMap(islandName, true);
                    }
                }
            }
        });
    }

    // 2) Mapa Leaflet
    const mapDiv = document.getElementById('canaryMap');
    let leafletMap = null;
    const islandMarkers = {};

    function refreshMapSize() {
        if (leafletMap) {
            leafletMap.invalidateSize();
        }
    }

    if (mapDiv && typeof L !== 'undefined') {
        leafletMap = L.map('canaryMap', {
            zoomControl: true,
            attributionControl: true
        }).setView([28.4, -15.6], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 10,
            minZoom: 5,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(leafletMap);

        const ISLAND_COORDS = {
            "Tenerife": [28.293, -16.621],
            "Gran Canaria": [27.95, -15.6],
            "Lanzarote": [29.04, -13.64],
            "Fuerteventura": [28.35, -14.05],
            "La Palma": [28.68, -17.86]
        };

        ISLANDS_MAP.forEach(info => {
            const name = info.island;
            const coords = ISLAND_COORDS[name];
            if (!coords) return;

            const share = info.share_pct || 0;
            const baseRadius = 6 + (share / 8);

            const marker = L.circleMarker(coords, {
                radius: baseRadius,
                color: '#facc15',
                weight: 1.2,
                fillColor: '#facc15',
                fillOpacity: 0.7
            }).addTo(leafletMap);

            marker._baseRadius = baseRadius;
            marker._share = share;
            marker._name = name;

            const touristsText = Math.round(info.tourists_12m || 0).toLocaleString('es-ES');
            marker.bindPopup(
                `<strong>${name}</strong><br>` +
                `${touristsText} turistas<br>` +
                `${share.toFixed(1)} % del total`
            );

            marker.on('mouseover', () => highlightIslandOnMap(name, false));
            marker.on('mouseout', () => highlightIslandOnMap(null, false));
            marker.on('click', () => highlightIslandOnMap(name, true));

            islandMarkers[name] = marker;
        });

        setTimeout(refreshMapSize, 400);
        window.addEventListener('resize', refreshMapSize);
    }

    function highlightIslandOnMap(islandName, openPopup) {
        if (!leafletMap) return;

        Object.values(islandMarkers).forEach(m => {
            m.setRadius(m._baseRadius);
            m.setStyle({
                color: '#facc15',
                fillColor: '#facc15',
                weight: 1.2,
                fillOpacity: 0.7
            });
        });

        if (!islandName || !islandMarkers[islandName]) return;

        const marker = islandMarkers[islandName];
        marker.setRadius(marker._baseRadius + 4);
        marker.setStyle({
            color: '#f97316',
            fillColor: '#facc15',
            weight: 2,
            fillOpacity: 0.85
        });

        if (openPopup) {
            marker.openPopup();
            leafletMap.panTo(marker.getLatLng(), { animate: true, duration: 0.4 });
        }
    }

    // =========================
    //  L√ìGICA POP-UP FEEDBACK
    // =========================

    const feedbackTrigger = document.getElementById('feedbackTrigger');
    const feedbackModalOverlay = document.getElementById('feedbackModalOverlay');
    const feedbackCloseBtn = document.getElementById('feedbackCloseBtn');
    const feedbackNotNowBtn = document.getElementById('feedbackNotNowBtn');
    const feedbackForm = document.getElementById('feedbackForm');
    const feedbackStatus = document.getElementById('feedbackStatus');
    const feedbackRatingGroup = document.getElementById('feedbackRatingGroup');

    function openFeedbackModal() {
        if (!feedbackModalOverlay) return;
        feedbackModalOverlay.classList.add('visible');
        feedbackModalOverlay.setAttribute('aria-hidden', 'false');
    }

    function closeFeedbackModal() {
        if (!feedbackModalOverlay) return;
        feedbackModalOverlay.classList.remove('visible');
        feedbackModalOverlay.setAttribute('aria-hidden', 'true');
    }

    if (feedbackRatingGroup) {
        feedbackRatingGroup.addEventListener('click', (event) => {
            const label = event.target.closest('.feedback-chip');
            if (!label) return;

            feedbackRatingGroup.querySelectorAll('.feedback-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
            label.classList.add('selected');
            const input = label.querySelector('input[type="radio"]');
            if (input) input.checked = true;
        });
    }

    if (feedbackTrigger) {
        feedbackTrigger.addEventListener('click', () => {
            openFeedbackModal();
        });
    }

    if (feedbackCloseBtn) {
        feedbackCloseBtn.addEventListener('click', () => {
            localStorage.setItem('portfolio_feedback_dismissed', 'true');
            closeFeedbackModal();
        });
    }

    if (feedbackNotNowBtn) {
        feedbackNotNowBtn.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.setItem('portfolio_feedback_dismissed', 'true');
            closeFeedbackModal();
        });
    }

    if (feedbackModalOverlay) {
        feedbackModalOverlay.addEventListener('click', (e) => {
            if (e.target === feedbackModalOverlay) {
                localStorage.setItem('portfolio_feedback_dismissed', 'true');
                closeFeedbackModal();
            }
        });
    }

    if (feedbackForm) {
        feedbackForm.addEventListener('submit', (e) => {
            e.preventDefault();
            feedbackStatus.classList.remove('success', 'error');
            feedbackStatus.textContent = '';

            const formData = new FormData(feedbackForm);
            const rating = formData.get('rating') || '';
            const aspect = formData.get('aspect') || '';
            const comment = (formData.get('comment') || '').toString().trim();

            if (!rating) {
                feedbackStatus.classList.add('error');
                feedbackStatus.textContent = 'Por favor, selecciona una valoraci√≥n.';
                return;
            }

            const payload = {
                rating,
                aspect,
                comment,
                page: 'kanarytour_frontur_dashboard',
                timestamp: new Date().toISOString()
            };

            console.log('Nuevo feedback portfolio:', payload);

            feedbackStatus.classList.add('success');
            feedbackStatus.textContent = '¬°Gracias por tu feedback!';

            localStorage.setItem('portfolio_feedback_submitted', 'true');

            setTimeout(() => {
                closeFeedbackModal();
            }, 1200);
        });
    }

    (function autoOpenFeedbackOnce() {
        const alreadySubmitted = localStorage.getItem('portfolio_feedback_submitted') === 'true';
        const alreadyDismissed = localStorage.getItem('portfolio_feedback_dismissed') === 'true';

        if (alreadySubmitted || alreadyDismissed) return;

        setTimeout(() => {
            openFeedbackModal();
        }, 20000);
    })();
</script>

</body>
</html>
